<!DOCTYPE html>
<html>
<head>
    <title>Calorie Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        input, button { padding: 5px; margin: 5px; }
        #suggestions { 
            border: 1px solid #ccc; 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            max-height: 150px; 
            overflow-y: auto; 
            position: absolute; 
            background: white; 
            width: 200px;
            z-index: 1000;
        }
        #suggestions li { padding: 5px; cursor: pointer; }
        #suggestions li.selected { background-color: #b3d4fc; }
        .messages { list-style: none; padding: 0; }
        .messages li.error { color: red; }
        .messages li.success { color: green; }
        .messages li.info { color: blue; }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Calorie Tracker</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="messages">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('log_meal') }}" autocomplete="off">
        <input type="text" id="dish_name" name="dish_name" placeholder="Type dish name..." required>
        <ul id="suggestions" style="display:none;"></ul>
        <button type="submit">Log Meal</button>
    </form>

    <a href="{{ url_for('insights') }}">View Insights & Charts</a>

    <script>
        $(document).ready(function(){
            let selectedIndex = -1;

            function updateSelection() {
                $("#suggestions li").removeClass("selected");
                if(selectedIndex >= 0){
                    $("#suggestions li").eq(selectedIndex).addClass("selected");
                }
            }

            $("#dish_name").on("input", function(){
                let query = $(this).val();
                selectedIndex = -1;
                if(query.length > 0){
                    $.getJSON("/autocomplete?q=" + query, function(data){
                        let list = "";
                        data.forEach(function(item){
                            list += "<li class='suggest-item'>" + item + "</li>";
                        });
                        $("#suggestions").html(list).show();
                    });
                } else {
                    $("#suggestions").hide();
                }
            });

            $(document).on("click", ".suggest-item", function(){
                $("#dish_name").val($(this).text());
                $("#suggestions").hide();
            });

            $("#dish_name").keydown(function(e){
                let items = $("#suggestions li");
                if(items.length === 0) return;

                if(e.key === "ArrowDown") {
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateSelection();
                    e.preventDefault();
                } else if(e.key === "ArrowUp") {
                    selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                    updateSelection();
                    e.preventDefault();
                } else if(e.key === "Enter") {
                    if(selectedIndex >= 0){
                        $("#dish_name").val(items.eq(selectedIndex).text());
                        $("#suggestions").hide();
                        e.preventDefault();
                    }
                }
            });

            // Hide suggestions when clicking outside
            $(document).click(function(event) { 
                if(!$(event.target).closest('#dish_name, #suggestions').length) {
                    $("#suggestions").hide();
                }        
            });
        });
    </script>
</body>
</html>
